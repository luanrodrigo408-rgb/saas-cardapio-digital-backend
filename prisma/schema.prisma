// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== TENANTS (Multi-tenant support) =====
model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique // For subdomain or path-based routing
  name      String
  email     String   @unique
  plan      String   @default("free") // free | pro | enterprise
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users         User[]
  restaurants   Restaurant[]
  subscriptions Subscription[]
}

// ===== USERS =====
model User {
  id        String   @id @default(cuid())
  email     String
  password  String // bcrypt hashed
  name      String
  role      String   @default("user") // admin | manager | staff | user
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy: A user belongs to ONE tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([email, tenantId]) // Email unique per tenant
  @@index([tenantId])
}

// ===== RESTAURANTS =====
model Restaurant {
  id        String   @id @default(cuid())
  name      String
  slug      String
  description String?
  logo      String?
  phone     String?
  email     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  cnpj      String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  categories Category[]
  orders     Order[]

  @@unique([slug, tenantId])
  @@index([tenantId])
}

// ===== CATEGORIES =====
model Category {
  id        String   @id @default(cuid())
  name      String
  slug      String
  description String?
  icon      String?
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  products     Product[]

  @@unique([slug, restaurantId])
  @@index([restaurantId])
}

// ===== PRODUCTS =====
model Product {
  id        String   @id @default(cuid())
  name      String
  slug      String
  description String?
  price     Float
  image     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@unique([slug, categoryId])
  @@index([categoryId])
}

// ===== ORDERS =====
model Order {
  id        String   @id @default(cuid())
  orderNumber String
  status    String   @default("pending") // pending | confirmed | preparing | ready | delivered | cancelled
  total     Float
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items        OrderItem[]

  @@index([restaurantId])
}

model OrderItem {
  id        String   @id @default(cuid())
  quantity  Int
  price     Float
  subtotal  Float

  // Relations
  orderId String
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
}

// ===== SUBSCRIPTIONS =====
model Subscription {
  id        String   @id @default(cuid())
  plan      String   // free | pro | enterprise
  status    String   @default("active") // active | cancelled | expired
  startDate DateTime @default(now())
  endDate   DateTime?
  price     Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}
